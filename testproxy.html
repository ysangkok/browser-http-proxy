<!doctype html>
<title>Test browser HTTP Proxy</title>
<script src="build.js"></script>
<script>
"use strict";
var httpserver = require('http-server');

var buf = "";

window.handle_char = function(char) {
    buf += char;
    if (buf.slice(-1) === "\n") {
        console.log("post req");
        var parsed = JSON.parse(buf); //parse with \n but it parses anyway...
        buf = "";
        httpserver.postMessage(parsed);
    }
};

httpserver.setCallback(function(ev) {
    if (ev.Data && !ev.Data.startsWith("HTTP/1.1 200 OK"))
        throw new Error("test failed" + ev.Data);
    console.log("callback called: ", ev.Data);
});

handle_char(JSON.stringify({New:true,Data:btoa("GET http://ip.tyk.nu HTTP/1.0\r\n\r\n")})+"\n");
</script>
